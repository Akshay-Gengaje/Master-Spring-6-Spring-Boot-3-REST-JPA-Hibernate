# CORS (Cross-Origin Resource Sharing) -

**CORS (Cross-Origin Resource Sharing)** is a security feature implemented by web browsers that prevents JavaScript from making requests to a domain different from the one that served the web page. It's a way to relax the **Same-Origin Policy (SOP)**, which restricts how resources on a web page can interact with resources from another domain.

For example, if your frontend is served from `http://localhost:3000`, and your Spring Boot backend API is running on `http://localhost:8080`, the browser will block requests to the API by default because they are considered **cross-origin**. CORS allows the backend to explicitly permit certain domains to access its resources.

### CORS Flow

When a browser makes a cross-origin request (e.g., an API call from `http://localhost:3000` to `http://localhost:8080`), the browser first sends a **preflight request** (an HTTP OPTIONS request) to check whether the server allows the actual request. This preflight request asks the server whether it supports CORS and lists the HTTP methods and headers that are allowed.

If the server responds with appropriate CORS headers, the browser will make the actual request. Otherwise, the browser will block the request.

### CORS Headers

To control CORS, the server responds with specific headers in its HTTP response. These include:

1. **`Access-Control-Allow-Origin`**: Specifies which origin(s) are allowed to access the resource.
   
   - Example: `Access-Control-Allow-Origin: http://localhost:3000`
   - If set to `*`, any domain can access the resource.

2. **`Access-Control-Allow-Methods`**: Specifies the HTTP methods that are allowed for the resource.
   
   - Example: `Access-Control-Allow-Methods: GET, POST, PUT, DELETE`

3. **`Access-Control-Allow-Headers`**: Specifies which HTTP headers are allowed in the actual request.
   
   - Example: `Access-Control-Allow-Headers: Content-Type, Authorization`

4. **`Access-Control-Allow-Credentials`**: Indicates whether credentials (such as cookies or authorization headers) are allowed to be sent in the request.
   
   - Example: `Access-Control-Allow-Credentials: true`

5. **`Access-Control-Max-Age`**: Specifies how long the results of a preflight request can be cached.
   
   - Example: `Access-Control-Max-Age: 3600` (1 hour)

---

### How to Enable CORS in Spring Boot

Spring Boot provides several ways to configure CORS in your REST API. You can enable CORS globally or on a per-controller or per-method basis.

#### 1. **Global Configuration (using `WebMvcConfigurer`)**

You can configure CORS for the entire application using a **global configuration**. This is usually done by implementing the `WebMvcConfigurer` interface.

Example:

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")  // Apply CORS to all endpoints
                .allowedOrigins("http://localhost:3000")  // Allow specific origin(s)
                .allowedMethods("GET", "POST", "PUT", "DELETE")  // Allow specific methods
                .allowedHeaders("*")  // Allow all headers
                .allowCredentials(true)  // Allow credentials like cookies
                .maxAge(3600);  // Cache the preflight response for 1 hour
    }
}
```

- `addMapping("/**")`: Applies CORS settings to all endpoints.
- `allowedOrigins("http://localhost:3000")`: Only `http://localhost:3000` can make requests. You can also specify multiple origins.
- `allowedMethods("GET", "POST", "PUT", "DELETE")`: Specifies which HTTP methods are allowed.
- `allowedHeaders("*")`: Allows any headers in the request.
- `allowCredentials(true)`: Allows sending credentials (such as cookies or HTTP authentication).
- `maxAge(3600)`: The preflight request result will be cached for 1 hour.

#### 2. **Per-Controller or Per-Method Configuration (using `@CrossOrigin`)**

You can also use the `@CrossOrigin` annotation directly on controllers or specific request-handling methods to enable CORS for those endpoints.

**Example for a controller:**

```java
@RestController
@CrossOrigin(origins = "http://localhost:3000")
@RequestMapping("/api")
public class UserController {

    @GetMapping("/users")
    public List<User> getUsers() {
        return userService.getAllUsers();
    }
}
```

- The `@CrossOrigin` annotation at the class level enables CORS for all endpoints in that controller.

**Example for a method:**

```java
@GetMapping("/users/{id}")
@CrossOrigin(origins = "http://localhost:3000")
public User getUser(@PathVariable Long id) {
    return userService.getUserById(id);
}
```

- The `@CrossOrigin` annotation at the method level enables CORS only for that specific endpoint.

#### 3. **Enabling CORS for Spring Security**

If your Spring Boot application uses **Spring Security**, CORS should also be explicitly enabled in the security configuration. Spring Security by default blocks CORS requests, so you need to configure it as follows:

```java
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .cors()  // Enable CORS with Spring Security
            .and()
            .csrf().disable();  // Disable CSRF if needed (CORS and CSRF are different mechanisms)

        return http.build();
    }
}
```

- `http.cors()`: This tells Spring Security to apply the CORS configuration defined in `WebMvcConfigurer` or via `@CrossOrigin` annotations.
- Note: CORS and **CSRF (Cross-Site Request Forgery)** are two different mechanisms, and disabling CSRF might be necessary in some cases, especially for APIs. However, it should be done with caution, particularly for state-changing operations (like POST requests) that might need additional security.

---

### Preflight Requests

A **preflight request** is an HTTP OPTIONS request sent by the browser to the server before the actual cross-origin request. This happens when the request:

- Uses HTTP methods like `PUT`, `DELETE`, or any method other than `GET` or `POST`.
- Contains custom headers (other than standard headers like `Content-Type`).

The preflight request asks the server if it allows the cross-origin request by checking the **CORS headers**.

Example preflight request:

```
OPTIONS /api/resource HTTP/1.1
Host: localhost:8080
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Content-Type
```

The server should respond with appropriate CORS headers to indicate whether the request is allowed:

```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: POST
Access-Control-Allow-Headers: Content-Type
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 3600
```

If the preflight request succeeds, the browser will then send the actual request. If it fails, the browser will block the request.

---

### Key Points

1. **CORS is a browser security feature**, not something enforced by the server. However, the server needs to send the correct headers to allow or deny cross-origin requests.
2. **Preflight requests** are sent by the browser before actual requests to determine if the server allows the cross-origin request.
3. **Spring Boot's CORS support** can be configured globally via `WebMvcConfigurer` or locally with the `@CrossOrigin` annotation.
4. If using **Spring Security**, CORS also needs to be enabled in the security configuration.
5. **CORS headers** like `Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, and `Access-Control-Allow-Headers` dictate which origins, methods, and headers are allowed.

---

### Debugging CORS Issues

- If CORS is not configured correctly, you'll typically see errors in the browser console, like:
  - `Access to XMLHttpRequest at 'http://localhost:8080/api/resource' from origin 'http://localhost:3000' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.`
- Always check that the server sends the necessary CORS headers in the response.
- Use browser developer tools to inspect the preflight (OPTIONS) and actual requests to diagnose issues.

By following the above configurations and understanding how CORS works, you can effectively manage cross-origin requests in your Spring Boot application and prevent common CORS issues.
